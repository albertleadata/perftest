#!/usr/bin/python
from __future__ import print_function
from os.path import expanduser
from jenkinsapi.jenkins import Jenkins
from jenkinsapi.utils.crumb_requester import CrumbRequester
import sys
import time
import MySQLdb
import json
import ssl
import urllib
import urllib2

sHome=expanduser("~")
sHostURL='http://bluejayhost:8080'
pAuth={	'bjhst':'bluejayhost',
			'bjusr':'bluejaylogin',
			'bjpwd':'bluejaypassword',
			'jusr':'jenkinsuser',
			'jpwd':'jenkinspassword',
			'dbhost':'databasehost',
			'dblogin':'databaselogin',
			'dbpassword':'databasepassword',
			'dbname':'databasename',
			'oso':'openshiftoriginhost',
			'odr':'openshiftdockerrepo',
			'oat':'openshiftapitoken',
			'osv':'bluejayreportsvolume' }

def loadConfig( sCfgFile=".bluejayrc"):
	global sHome
	global sHostURL
	global pAuth
	fCfg = open( sHome+"/"+sCfgFile, "r")
	for sLine in fCfg:
		pOpt = sLine.split( "=", 1)
		if pOpt[0].rstrip() == "bluejay.jenkins.host":
			sHostURL = pOpt[1].lstrip().rstrip()
		elif pOpt[0].rstrip() == "bluejay.jenkins.user":
			pAuth['jusr'] = pOpt[1].lstrip().rstrip()

def genRptSummary( sFile, lTst, sURL):
	with open( sFile, "r") as fJSON:
		sJSON = "{\"op\":\"teststatus\",\"id\":\""+str(lTst)+"\",\"status\":\"TEST_PUBLISHED\",\"rpturl\":\""+sURL+"\""
		pData = json.load( fJSON)
		sItm = "\"ttl\":"+str(pData['numberOfRequests']['total'])
		sJSON += ","+sItm
		sItm = "\"ok\":"+str(pData['numberOfRequests']['ok'])
		sJSON += ","+sItm
		sItm = "\"ko\":"+str(pData['numberOfRequests']['ko'])
		sJSON += ","+sItm
		sItm = "\"mreq\":"+str(pData['meanNumberOfRequestsPerSecond']['total'])
		sJSON += ","+sItm
		sItm = "\"mok\":"+str(pData['meanNumberOfRequestsPerSecond']['ok'])
		sJSON += ","+sItm
		sItm = "\"mko\":"+str(pData['meanNumberOfRequestsPerSecond']['ko'])
		sJSON += ","+sItm
		sItm = "\"min\":"+str(pData['minResponseTime']['ok'])
		sJSON += ","+sItm
		sItm = "\"max\":"+str(pData['maxResponseTime']['ok'])
		sJSON += ","+sItm
		sItm = "\"mean\":"+str(pData['meanResponseTime']['ok'])
		sJSON += ","+sItm
		sItm = "\"std\":"+str(pData['standardDeviation']['ok'])
		sJSON += ","+sItm
		sItm = "\"p1\":"+str(pData['percentiles1']['ok'])
		sJSON += ","+sItm
		sItm = "\"p2\":"+str(pData['percentiles2']['ok'])
		sJSON += ","+sItm
		sItm = "\"p3\":"+str(pData['percentiles3']['ok'])
		sJSON += ","+sItm
		sItm = "\"p4\":"+str(pData['percentiles4']['ok'])
		sJSON += ","+sItm
		sJSON += "}"
		print( "%s" % sJSON)

def cmdStatus():
	print( "%s" % "Usage: bjrpt --summary=filename --test=numerictestid --url=http://somereporturl")

if __name__ == '__main__':
	sCmd="status"
	loadConfig()
	sFileName = ""
	lTst = 0
	sURL = ""
	sRPC = ""
#	Command-line argument processing ...
	for arg in sys.argv:
		pair = arg.split( "=", 1)
		if pair[0] == "--summary":
			sCmd="summary"
			sFileName=pair[1]
		elif pair[0] == "--test":
			lTst=int(pair[1])
		elif pair[0] == "--url":
			sURL=pair[1]
#	Command routing ...
	if sCmd == "api":
		bluejayAPI( sRPC)
	elif sCmd == "summary":
		genRptSummary( sFileName, lTst, sURL)
	else:
		cmdStatus()
