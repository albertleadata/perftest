#!/bin/bash
HDL=/opt/app-root
TDL=${HDL}
NGN=${1}
JNS=${2}
DHN=${3}
JHN=$(grep bluejay.${NGN}.jhn ${HOME}/.bluejayrc | cut -d= -f2 | sed "s/  *//g")

function rptGenMaven {
	JWD=$(pwd)
	RDN=${JNS}-$(date +%Y%d%m%H%M%S)
	echo "DBG=>>> target/gatling contents ..."
	ls target/gatling
	echo "DBG=>>> =-=-=-=-=-=-=-=-=-=-=-=-=-="
	RLD=$(ls target/gatling | head -1)
	if [ -d target/gatling/${RLD} ]; then
		mkdir -p ${JWD}/reports/${RDN}
		rsync -rltDOi target/gatling/${RLD}/ ${JWD}/reports/${RLD}/
	#	zip ${JWD}/reports/${RLD}/results-bundle.zip results
	fi
}

function rptGenGatlingJarvis {
	echo "DBG=>>> ngnrpt processing from $(PWD) (should be ${HDL}) ..."
	GSF=$(find ${HDL}/reports -type f | grep "global_stats.json" | head -1)
	echo "DBG=>>> ngnrpt - Gatling global_status.json detection: ${GSF}"
	if [ -r "${GSF}" ]; then
		echo "DBG=>>> ngnrpt - processing stats with ${GSF}, $(cat eid.txt), $(cat rpturl.txt)"
		echo "DBG=>>> ngnrpt - using script $(ls -l ${HDL}/bin/bjrpt)"
		${HDL}/bin/bjrpt --summary=${GSF} --test=$(cat eid.txt) --url="$(cat rpturl.txt)" > gatrsp.json
		echo "DBG=>>> JSON payload:"
		cat gatrsp.json
	fi
}

# Process based on profile's context (engine + origin/Jarvis)
if [ "${JHN}" != "skip" ]; then
	if [ "${NGN}" == "gatling" ]; then
		rptGenGatlingJarvis
	elif [ "${NGN}" == "maven" ]; then
		rptGenMaven
	else
		echo "NFO=>>> ${NGN} engine reporting callback for Jarvis skipped (undefined)"
	fi
else
	if [ "${NGN}" == "maven" ]; then
		rptGenMaven
	else
		echo "NFO=>>> ${NGN} engine reporting callback skipped (undefined)"
	fi
fi
